\documentclass[b5paper]{book}
\usepackage[
    b5paper,
		margin=1.5cm,
	]{geometry}
\setlength\parindent{0em}
\setlength{\parskip}{1em}

\usepackage{booktabs}
\usepackage{blindtext}

%-----------%
% XREF DICT %
%-----------%

\usepackage{pgfkeys}
\pgfkeyssetvalue{/xref dict/fig}{Figure}
\pgfkeyssetvalue{/xref dict/eq}{Equation}
\pgfkeyssetvalue{/xref dict/eqs}{Equations}
\pgfkeyssetvalue{/xref dict/tab}{Table}
\pgfkeyssetvalue{/xref dict/def}{Definition}
\pgfkeyssetvalue{/xref dict/note}{Note}
\pgfkeyssetvalue{/xref dict/challange}{Challange}
\pgfkeyssetvalue{/xref dict/example}{Example}

%----------%
% GRAPHICS %
%----------%

\usepackage{tikz}
\usepackage{tikzpagenodes}
\usetikzlibrary{calc, decorations.pathreplacing, decorations.text}

\tikzset{
	arrow/.style={thick, ->, >=stealth},
	vector/.style={very thick, ->, >=stealth},
}

%-------%
% FONTS %
%-------%

\usepackage{kpfonts}

%--------%
% COLORS %
%--------%

\usepackage{xcolor}
\usepackage{colortbl}
\definecolor{xblue}{HTML}{4268BD}
\definecolor{xred}{HTML}{BD4242}
\definecolor{xgreen}{HTML}{52B256}
\definecolor{xpurple}{HTML}{7F52B2}
\definecolor{xorange}{HTML}{B93F0B}
\definecolor{xdotted}{HTML}{999999}

% Document-specific colors
\colorlet{normaltextcolor}{black}
\colorlet{figtextcolor}{xblue}

%------- %
% XHFILL %
%------- %

\usepackage{xhfill}

%---------------%
% CHAPTER TITLE %
%---------------%

% Used to set chapter title look.
% "explicit" is there so we can
% use the first parameter (#1).
\usepackage[explicit]{titlesec}
\newcommand{\chapternumsize}{\fontsize{70}{70}\selectfont}
\newcommand{\chaptertitlesize}{\fontsize{30}{30}\selectfont}

%\newcommand{\newchapter}[1]{
%	\begin{tikzpicture}[overlay, remember picture]
%		\coordinate (boxtopright) at (current page text area.east |- current page.north);
%		\coordinate (boxbottomleft) at ($(boxtopright)-(3cm,5cm)$);
%		\coordinate (boxbottomright) at (boxtopright |- boxbottomleft);
%		\coordinate (lineleft) at (current page text area.west |- boxbottomleft);
%
%		%\draw[thick] (boxbottomright) to (lineleft);
%		\filldraw[xblue, rounded corners=4mm] ($(boxtopright)+(0,1cm)$) rectangle (boxbottomleft) node [midway, text=white, text width=3cm, align=center, yshift=-5mm] (chapternum) {\Large CHAPTER\\\vspace{7mm}\chapternumsize\thechapter};
%		\node[anchor=south west, xshift=-4pt, align=left, text width=10cm] at (lineleft |- chapternum.south) {\chaptertitlesize #1};
%	\end{tikzpicture}
%}

\titleformat{\chapter}{\sffamily\bfseries}{}{0pt}{
	\centering
	\begin{tikzpicture}[font=\sffamily\bfseries]
		\fill[xblue!30, rounded corners] (0,0) rectangle (5cm,5cm);
		\node at (2.5cm,4.5cm) {\fontsize{85}{85}\selectfont\thechapter};
		\node[align=center] at (2.5cm, -1cm) {\fontsize{30}{30}\selectfont\uppercase{#1}};
	\end{tikzpicture}
}

\titleformat{\section}{\sffamily\Large\bfseries}{\huge{\thesection}}{1em}{\xdotfill[1ex]{1pt}[xdotted]\newline\hspace{-5cm}\uppercase{#1}}

\titleformat{\subsection}{\sffamily\large\bfseries}{}{0em}{\uppercase{#1}}

%---------%
% HEADERS %
%---------%

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}% Clear header/footer
\renewcommand{\chaptermark}[1]{\markboth{\chaptername\ \thechapter:\ #1}{}}
\fancyhead[RO,LE]{\leftmark}% Chapter details in book
\fancyfoot[RO,LE]{\thepage}
\makeatother

%-------%
% BOXES %
%-------%

\usepackage{fontawesome}
\usepackage[most]{tcolorbox}
\tcbset{
	common/.style={
		lower separated=false,
		coltitle=white,
		colback=gray!5,
		boxrule=0.5pt,
		fonttitle=\bfseries,
		enhanced,
		breakable,
		top=8pt,
		before skip=8pt,
		attach boxed title to top left={
			yshift=-0.25cm,
			xshift=0.38cm},
		boxed title style={
			boxrule=0pt,
			colframe=white,
			arc=0pt,
			outer arc=0pt},
		separator sign={~~},},
	defstyle/.style={
		common,
		colframe=xpurple,
		colback=xpurple!5,
		colbacktitle=xpurple,
		overlay unbroken and last={
			\node[anchor=south east, outer sep=0pt] at (\linewidth-width, 0) {
				\textcolor{xpurple}{$\pi$}};}},
	exmplstyle/.style={
		common,
		colframe=xblue,
		colback=xblue!5,
		colbacktitle=xblue,
		overlay unbroken and last={
			\node[anchor=south east, outer sep=0pt, font=\large\bfseries] at (\linewidth-width, 1) {
				\textcolor{xblue}{\faArrowCircleDown}};}},
	notestyle/.style={
		common,
		colframe=xred,
		colback=xred!5,
		colbacktitle=xred,
		overlay unbroken and last={
			\node[anchor=south east, outer sep=0pt, font=\large\bfseries] at (\linewidth-width, 1) {
				\textcolor{xred}{!}};}},
	chllngstyle/.style={
		common,
		colframe=xgreen,
		colback=xgreen!5,
		colbacktitle=xgreen,
		overlay unbroken and last={
			\node[anchor=south east, outer sep=0pt, font=\large\bfseries] at (\linewidth-width, 0) {
				\textcolor{xgreen}{?}};}},
	thmstyle/.style={
		common,
		colframe=second,
		colback=second!5,
		colbacktitle=second,
		overlay unbroken and last={
			\node[anchor=south east, outer sep=0pt] at (\linewidth-width,0) {
				\textcolor{second}{$\heartsuit$}};}},
	}
\newtcbtheorem[auto counter, number within=chapter]{definition}{Definition}{defstyle}{def}
\newtcbtheorem[auto counter, number within=chapter]{example}{Example}{exmplstyle}{example}
\newtcbtheorem[auto counter, number within=chapter]{note}{Note}{notestyle}{note}
\newtcbtheorem[auto counter, number within=chapter]{challange}{Challange}{chllngstyle}{challange}

%---------%
% FIGURES %
%---------%

\usepackage{float}
\usepackage{caption}
\usepackage[colorlinks=true, linkcolor=xblue]{hyperref}

% Caption label
\DeclareCaptionLabelSeparator{doublespace}{\ \ }
\captionsetup{labelfont={color=xblue,bf}, figurename=Figure, labelsep=doublespace}

% Refs format
\newcommand{\xref}[2][fig]{
	\color{figtextcolor}\textbf{\pgfkeysvalueof{/xref dict/#1}}~\ref{#1:#2} \color{normaltextcolor}
}

%-------------------%
% HIGHLIGHTED WORDS %
%-------------------%

\usepackage{imakeidx}
\usepackage{marginnote}
\makeindex
\renewcommand\emph[1]{\color{xpurple}{\textbf{#1}}\color{normaltextcolor}\index{#1}}%\marginnote[#1]{}

%-------%
% MATHS %
%-------%

\usepackage{amsmath, bm}
\usepackage{siunitx}

%----------%
% DOCUMENT %
%----------%

\begin{document}

% Chapters
\input{chapters/intro.tex}

% For tests
\chapter{This is a Test Title}
\section{The Foo and the Bar}
\subsection{The Foo; or: Why Does a Fish?}
\Blindtext
\begin{definition}{The Foo}{}
	A Foo is simply a thing, i.e.
	\begin{equation}
		e^{i\pi} = -e^{i\tau} = -1.
		\label{eq:a thing}
	\end{equation}
\end{definition}
\Blindtext[1]
\begin{example}{A Bla which is not a Foo}{}
	Is there even such a thing? Consider
	\begin{equation*}
		f(x) = \sin(x)+5x^{2}.
	\end{equation*}
\end{example}
\subsection{The Bar, the One and Only}
\Blindtext[3]
\begin{note}{Something to Consider}{}
	Bla bla bla, yada yada yada.
	~\\
	~\\
	More lines.
\end{note}
\Blindtext[2]

In the middle of this random Lorem Ipsum, there are some other words! This is refreshing, isn't it? Any way, this is used to test some \emph{highlighting} and \emph{indexing} of words. I hope it works. Well, it doesn't. I need to check how to make the marginnotes to go to the left side in odd pages.

\Blindtext[2]
\begin{challange}{Generalize this thing}{}
	In 2D, the distance between two points $\bm{A}=(A_{x},A_{y})$ and $\bm{B}=(B_{x},B_{y})$ is
	\begin{equation}
		|AB| = \sqrt{(A_{x}-B_{x})^{2} + (A_{y}-B_{y})^{2}}.
		\label{eq:dist2D}
	\end{equation}
	Generalize this to 3D and to $N$D, where $N\in\mathbb{N}$.
\end{challange}

\Blindtext[1]

As you probably learned in school, a \emph{triangle} is a shape with three sides. An example of a triangle can be seen in \xref{triangle}.

\begin{figure}[H]
	\centering
	\begin{tikzpicture}
		\draw[thick, fill=xblue!50] (0,0) node [left] {$A$} -- (1,2) node [above] {$B$} -- (2,-1) node [right] {$C$} -- cycle;
	\end{tikzpicture}
	\caption{This is a triangle.}
	\label{fig:triangle}
\end{figure}
\printindex
\end{document}
